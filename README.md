# rspec_n

rspec_n is a Ruby gem that makes it easy to run a project's RSpec test suite N times.  You can customize the command that is used to start RSpec, or let rspec_n guess the best command (based on the files in your project).  rspec_n is useful for finding repeatability or flakiness issues in automated test suites.

![sample](https://user-images.githubusercontent.com/2053901/52986788-d0bb7c80-33c6-11e9-9f13-0e191bdd2bb3.png)

## Version Policy

Releases are versioned using [semver 2.0.0](https://semver.org/spec/v2.0.0.html).

## Supported Rubies

Ruby 2.3.7+ is supported.

## Installation

Install by executing

    $ gem install rspec_n

The gem will install an exectuable called `rspec_n` on your system.  You may also want to add `rspec_n_iteration.*` to your `.gitignore` to exclude the output generated by rspec_n from your project's repo.

## Usage

The simplest way to run rspec_n is to give it a positive integer which tells it how many times to run RSpec:

    $ rspec_n 5

As each iteration completes, output will be sent to the screen and dumped to a file.  If you need to examine the detailed output of a run, it is available in the output files.

You can also list one or more paths to target specs.  You can do anything you would normally do when giving RSpec paths:

    $ rspec_n 5 spec/path/to/something_spec.rb
    $ rspec_n 5 spec/path/to/folder spec/path/to/some/other/file_spec.rb
    $ rspec_n 5 spec/path/to/folder
    $ rspec_n 5 spec/path/to/something_spec.rb:5

By default, `--order rand` is sent to RSpec to force it to run specs in random order.  You can use a `defined` order if you don't want randomness:

    $ rspec_n 5 --order defined

Or, let the configuration files in the project determine the order:

    $ rspec_n 5 --order project

#### Automatic Command Selection

rspec_n will inspect the files in your project and pick the best way to start RSpec.  If it can't make an educated guess, it will use `bundle exec rspec` as the base command and add any extra information you've entered on the command line (like the order or paths).  The following is a list of project types that rspec_n can identify and the associated commands it will try to execute:

1. Ruby on Rails Applications: `DISABLE_DATABASE_ENVIRONMENT_CHECK=1 RAILS_ENV=test bundle exec rake db:drop db:create db:migrate && bundle exec rspec`.
2. Everything else: `bundle exec rspec`.

#### Use Custom Command to Start RSpec

If you don't want rspec_n to automatically pick the best command, you can use the `-c` option and specify a command.  The following example deletes the `tmp` folder before starting RSpec:

    $ rspec_n 5 -c 'rm -rf tmp && bundle exec rspec'

There are couple points to consider:

1. Wrap your entire command in a single or double quoted string so rspec_n can acturately determine the command.
1. You can use the `&&` operator to join commands.
1. rspec_n was partially created to help discover flaky test suites so it will add `--order rand` to a custom command even if don't specify the order.  You must explicitly use `--order defined` or `--order project` if you want something else.

#### Control File Output

rspec_n writes output for each iteration in a sequence of files `rspec_n_iteration.1`, `rspec_n_iteration.2`, etc...  This saves you from having to rerun your test suite when you find a particular seed that causes your test suite to fail.  If you want to disable this, add the `--no-file` option to the command.

    $ rspec_n 5 --no-file

**Note:** rspec_n deletes all files matching `rspec_n_iteration.*` when it starts so be sure tomove those files to another location if you want to save them.

#### Stop on First Failure

You can tell rspec_n to abort the first time an iteration fails by using the `-s` flag.  Any remaining iterations will be skipped.

## Development

After checking out the repo, run `bin/setup` to install dependencies. Then, run `rake spec` to run the tests. You can also run `bin/console` for a Pry console, or `rake console` for an IRB console, that will allow you to experiment.

To install this gem onto your local machine, run `bundle exec rake install`. To release a new version, update the version number in `version.rb`, and then run `bundle exec rake release`, which will create a git tag for the version, push git commits and tags, and push the `.gem` file to [rubygems.org](https://rubygems.org).

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/roberts1000/rspec_n.

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).
