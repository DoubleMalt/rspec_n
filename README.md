# rspec_n

rspec_n is a Ruby gem that makes it easy to run a project's RSpec test suite N times.  You can customize the command that is used to start RSpec, or let rspec_n guess the best command (based on the files in your project).  rspec_n is useful for finding repeatability or flakiness issues in automated test suites.

![example](https://user-images.githubusercontent.com/2053901/53691471-c6956880-3d4c-11e9-8248-68bbb4c24786.png)

## Version Strategy

Releases are versioned using [semver 2.0.0](https://semver.org/spec/v2.0.0.html).

## Supported Rubies

Ruby 2.3.0+ is supported.

## Installation

Install by executing

    $ gem install rspec_n

The gem will install an exectuable called `rspec_n` on your system.  You may also want to add `rspec_n_iteration.*` to your `.gitignore` to exclude the output generated by rspec_n from your project's repo.

#### Using in a Gemfile

If you want to add rspec_n to your Gemfile, make sure you use the `require: false` option so rspec_n files aren't loaded into your application.  rspec_n doesn't provide any runtime benefit to an app and requiring it will add unnecessary code to your project.  Also, rspec_n is designed as a standalone commandline tool and isn't tested for compatibility inside other apps.

    ```ruby
    gem 'rspec_n', require: false
    ```

## Usage

The simplest way to run rspec_n is to give it a positive integer which tells it how many times to run RSpec:

    $ rspec_n 5

As each iteration completes, output will be sent to the screen and dumped to a file.  If you need to examine the detailed output of a run, it is available in the output files.

You can also list one or more paths to target specs.  You can do anything you would normally do when giving RSpec paths:

    $ rspec_n 5 spec/path/to/something_spec.rb
    $ rspec_n 5 spec/path/to/folder spec/path/to/some/other/file_spec.rb
    $ rspec_n 5 spec/path/to/folder
    $ rspec_n 5 spec/path/to/something_spec.rb:5

By default, `--order rand` is sent to RSpec to force it to run specs in random order.  You can use a `defined` order if you don't want randomness:

    $ rspec_n 5 --order defined

Or, let the configuration files in the project determine the order:

    $ rspec_n 5 --order project

#### Automatic Command Selection

rspec_n will inspect the files in your project and pick the best way to start RSpec.  If it can't make an educated guess, it will use `bundle exec rspec` as the base command and add any extra information you've entered on the command line (like the order or paths).  The following is a list of project types that rspec_n can identify and the associated commands it will try to execute:

1. Ruby on Rails Applications: `DISABLE_DATABASE_ENVIRONMENT_CHECK=1 RAILS_ENV=test bundle exec rake db:drop db:create db:migrate && bundle exec rspec`.
2. Everything else: `bundle exec rspec`.

#### Use Custom Command to Start RSpec

If you don't want rspec_n to automatically pick the best command, you can use the `-c` option and specify a command.  The following example deletes the `tmp` folder before starting RSpec:

    $ rspec_n 5 -c 'rm -rf tmp && bundle exec rspec'

There are couple points to consider:

1. Wrap your entire command in a single or double quoted string so rspec_n can acturately determine the command.
1. You can use the `&&` operator to join commands.
1. rspec_n was partially created to help discover flaky test suites so it will add `--order rand` to a custom command even if don't specify the order.  You must explicitly use `--order defined` or `--order project` if you want something else.

#### Control File Output

rspec_n writes output for each iteration in a sequence of files `rspec_n_iteration.1`, `rspec_n_iteration.2`, etc...  This saves you from having to rerun your test suite when you find a particular seed that causes your test suite to fail.  If you want to disable this, add the `--no-file` option to the command.

    $ rspec_n 5 --no-file

**Note:** rspec_n deletes all files matching `rspec_n_iteration.*` when it starts so be sure tomove those files to another location if you want to save them.

#### Stop on First Failure

You can tell rspec_n to abort the first time an iteration fails by using the `-s` flag.  Any remaining iterations will be skipped.

## Understanding the Results

rspec_n uses the STDOUT, STDERR and EXIT STATUS of the `rspec` command  to figure out what to show in the **Results** column.  The general results are determined by finding the line in RSpec's STDOUT that says `xyz examples, xyz failures, xyz pending`.  rspec_n considers the run to be successful if RSpec returns an EXIT STATUS of 0 **regardless of any content in the STDERR stream**; it considers the run to be a failure if RSpec's EXIT STATUS > 0.

There are times when RSpec's STDERR might have content, even though it returns an EXIT STATUS of 0. This frequently happens with deprecation notices and RSpec itself will pass the test suite in this situation. Unfortunately, it's not uncommon for code to write messages that look like errors to STDERR, but not actually raise an error and cause RSpec to fail a spec example.  rspec_n reports this situation by adding a `(Warning)` label to the results to indicate there's something extra in the STDERR that you might want to investigate.

## Development

After checking out the repo, run `bin/setup` to install dependencies. Then, run `rake spec` to run the tests. You can also run `bin/console` for a Pry console, or `rake console` for an IRB console, that will allow you to experiment.

To install this gem onto your local machine, run `bundle exec rake install`. To release a new version, update the version number in `version.rb`, and then run `bundle exec rake release`, which will create a git tag for the version, push git commits and tags, and push the `.gem` file to [rubygems.org](https://rubygems.org).

## Contributing

Bug reports and pull requests are welcome on GitHub at https://github.com/roberts1000/rspec_n.

## License

The gem is available as open source under the terms of the [MIT License](https://opensource.org/licenses/MIT).
